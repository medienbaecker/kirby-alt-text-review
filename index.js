(function(){"use strict";function l(a,e,t,s,i,n,u,p){var r=typeof a=="function"?a.options:a;return e&&(r.render=e,r.staticRenderFns=t,r._compiled=!0),r._scopeId="data-v-"+n,{exports:a,options:r}}const o={props:{page:{type:Number,default:1}},data(){return{currentImages:{},originalImages:{},saving:{},images:[],pagination:{page:1,pages:1,total:0,limit:100},loading:!1}},computed:{reviewedImagesCount(){return Object.values(this.currentImages).filter(a=>a.alt_reviewed).length},totalImagesCount(){return this.pagination.total},isComplete(){return this.pagination.total>0&&this.reviewedImagesCount===this.pagination.total},hasAnyChanges(){return Object.keys(this.currentImages).some(a=>this.hasChanges(a))},currentLanguage(){return this.$panel.language?this.$panel.language.code:null},groupedImages(){const a={};return this.images.forEach(e=>{const t=e.pageId;a[t]||(a[t]={pageTitle:e.pageTitle,pageId:e.pageId,pagePanelUrl:e.pagePanelUrl,pageSort:e.pageSort,images:[]}),a[t].images.push(e)}),Object.values(a).sort((e,t)=>e.pageSort!==null&&t.pageSort!==null?e.pageSort-t.pageSort:e.pageSort!==null&&t.pageSort===null?-1:e.pageSort===null&&t.pageSort!==null?1:e.pageTitle.localeCompare(t.pageTitle))}},watch:{page(a){this.loadImages(a)},currentLanguage(a,e){if(a!==e&&e!==void 0){if(Object.keys(this.currentImages).some(s=>this.hasChanges(s))&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;this.loadImages(this.page)}}},created(){this.loadImages(this.page)},mounted(){window.panel.events.on("keydown.cmd.s",this.saveAllChanges)},beforeDestroy(){window.panel.events.off("keydown.cmd.s",this.saveAllChanges)},methods:{async loadImages(a=1){this.loading=!0;try{const e=await this.$api.get("alter/images",{page:a});this.images=e.images,this.pagination=e.pagination,this.initializeImageData()}catch(e){console.error("Failed to load images:",e),this.$panel.notification.error("Failed to load images")}finally{this.loading=!1}},initializeImageData(){this.currentImages={},this.originalImages={},this.saving={},this.images.forEach(a=>{const e={alt:a.alt,alt_reviewed:a.alt_reviewed};this.$set(this.originalImages,a.id,{...e}),this.$set(this.currentImages,a.id,{...e}),this.$set(this.saving,a.id,!1)})},onPageChange(a){if(Object.keys(this.currentImages).some(s=>this.hasChanges(s))&&!confirm(this.$t("medienbaecker.alter.unsavedChanges")))return;const t=a.page||a;this.$go(`/alter/${t}`)},getImageData(a){return this.currentImages[a]||{alt:"",alt_reviewed:!1}},hasChanges(a){const e=this.currentImages[a],t=this.originalImages[a];return!e||!t?!1:e.alt!==t.alt||e.alt_reviewed!==t.alt_reviewed},async saveImage(a){this.$set(this.saving,a,!0);try{const e=this.currentImages[a],t=this.originalImages[a];e.alt!==t.alt&&await this.updateField(a,"alt",e.alt),e.alt_reviewed!==t.alt_reviewed&&await this.updateField(a,"alt_reviewed",e.alt_reviewed?"true":""),this.$set(this.originalImages,a,{...e}),this.$panel.notification.success()}catch(e){this.$panel.notification.error(this.$t("medienbaecker.alter.error")),console.error(e)}finally{this.$set(this.saving,a,!1)}},async updateField(a,e,t){const s=await this.$api.post("alter/update",{imageId:a,field:e,value:t});if(s.error)throw new Error(s.error);return s},saveAllChanges(a){a&&a.preventDefault();const e=[];Object.keys(this.currentImages).forEach(t=>{this.hasChanges(t)&&e.push(t)}),e.length!==0&&e.forEach(t=>{this.saveImage(t)})}}};var c=function(){var e=this,t=e._self._c;return t("k-panel-inside",{staticClass:"k-alter-view"},[t("k-header",{scopedSlots:e._u([{key:"buttons",fn:function(){return[t("k-button",{style:{visibility:e.hasAnyChanges?"visible":"hidden"},attrs:{icon:"check",theme:"orange",variant:"filled",size:"sm"},on:{click:e.saveAllChanges}},[e._v(" "+e._s(e.$t("medienbaecker.alter.save"))+" ")]),!e.loading&&e.totalImagesCount>0?t("k-button",{attrs:{element:"span",variant:"filled",size:"sm",theme:e.isComplete?"positive":null}},[e._v(" "+e._s(`${e.reviewedImagesCount}/${e.totalImagesCount}`)+" ")]):e._e(),e.currentLanguage?t("k-button",{attrs:{element:"span",variant:"filled",size:"sm"}},[e._v(" "+e._s(e.currentLanguage.toUpperCase())+" ")]):e._e()]},proxy:!0}])},[e._v(" "+e._s(e.$t("medienbaecker.alter.title"))+" ")]),e.loading?t("div",{staticClass:"k-loader"},[t("k-loader")],1):e.images.length===0?t("div",{staticClass:"k-empty"},[t("k-text",[e._v(e._s(e.$t("medienbaecker.alter.noImages")))])],1):t("div",[e._l(e.groupedImages,function(s){return t("div",{key:s.pageId,staticClass:"page-group"},[t("div",{staticClass:"page-group__header"},[t("k-link",{staticClass:"page-group__title",attrs:{to:s.pagePanelUrl}},[t("k-headline",{attrs:{size:"h2"}},[e._v(e._s(s.pageTitle))])],1),t("k-badge",[e._v(" "+e._s(s.images.length)+" "+e._s(s.images.length===1?e.$t("medienbaecker.alter.image"):e.$t("medienbaecker.alter.images"))+" ")])],1),t("k-grid",{staticClass:"page-group__grid",staticStyle:{"--columns":"2",gap:"1rem"}},e._l(s.images,function(i){return t("div",{key:i.id,staticClass:"alt-review-card",class:{"alt-review-card--has-changes":e.currentImages[i.id]&&e.hasChanges(i.id)}},[t("k-link",{staticClass:"alt-review-card__image-link",attrs:{to:i.panelUrl}},[t("k-image-frame",{attrs:{src:i.url,alt:e.getImageData(i.id).alt,back:"pattern",ratio:"3/2"}})],1),t("div",{staticClass:"alt-review-card__content"},[t("k-text",{staticClass:"alt-review-card__filename"},[t("strong",[e._v(e._s(i.filename))])]),t("k-text-field",{staticClass:"alt-review-card__alt-input",attrs:{value:e.currentImages[i.id]?e.currentImages[i.id].alt:"",placeholder:e.$t("medienbaecker.alter.noAltText")},on:{input:function(n){e.currentImages[i.id]&&(e.currentImages[i.id].alt=n)}}}),t("label",{staticClass:"alt-review-card__checkbox"},[t("input",{staticClass:"alt-review-card__checkbox-input",attrs:{type:"checkbox"},domProps:{checked:e.getImageData(i.id).alt_reviewed},on:{change:function(n){return e.$set(e.currentImages[i.id],"alt_reviewed",n.target.checked)}}}),t("span",{staticClass:"alt-review-card__checkbox-label"},[e._v(e._s(e.$t("medienbaecker.alter.reviewed")))])])],1)],1)}),0)],1)}),e.pagination.total>e.pagination.limit?t("k-pagination",{staticStyle:{"margin-top":"2rem"},attrs:{page:e.pagination.page,total:e.pagination.total,limit:e.pagination.limit,details:!0},on:{paginate:e.onPageChange}}):e._e()],2)],1)},g=[],d=l(o,c,g,!1,null,"4fdaca20");const h=d.exports;panel.plugin("medienbaecker/alter",{components:{"k-alter-view":h}})})();
